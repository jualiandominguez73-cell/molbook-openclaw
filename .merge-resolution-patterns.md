# Merge Conflict Resolution Patterns

## Context

Project went through multiple rebrands:

- **clawdbot** → **moltbot** → **openclaw** (final/current name)
- Branch naming: HEAD had `clawdbrain` (intermediate), fork/main has `openclaw` (final)

## Complete Naming Mappings

### Product/Brand Names

| Old (clawdbot) | Intermediate (moltbot/clawdbrain) | New (openclaw) |
| -------------- | --------------------------------- | -------------- |
| Clawdbot       | Moltbot / Clawdbrain              | **OpenClaw**   |
| clawdbot       | moltbot / clawdbrain              | **openclaw**   |
| CLAWDBOT       | MOLTBOT / CLAWDBRAIN              | **OPENCLAW**   |

### Package/Module Names

| Old                      | Intermediate               | New                          |
| ------------------------ | -------------------------- | ---------------------------- |
| com.clawdbot.android     | com.clawdbrain.android     | **ai.openclaw.android**      |
| ClawdbotKit              | ClawdbrainKit / MoltbotKit | **OpenClawKit**              |
| ClawdbotTheme            | ClawdbrainTheme            | **OpenClawTheme**            |
| ClawdbotApp              | ClawdbrainApp              | **OpenClawApp**              |
| clawdbot-a2ui-\*         | clawdbrain-a2ui-\*         | **openclaw-a2ui-\***         |
| clawdbotCanvasA2UIAction | clawdbrainCanvasA2UIAction | **openclawCanvasA2UIAction** |
| clawdbotA2UI             | clawdbrainA2UI             | **openclawA2UI**             |
| ClawdbotPaths            | ClawdbrainPaths            | **OpenClawPaths**            |
| ClawdbotEnv              | ClawdbrainEnv              | **OpenClawEnv**              |
| ClawdbotBonjour          | ClawdbrainBonjour          | **OpenClawBonjour**          |
| ClawdbotConfig           | ClawdbrainConfig           | **OpenClawConfig**           |
| ClawdbotOAuth\*          | ClawdbrainOAuth\*          | **OpenClawOAuth\***          |
| ClawdbotProtocol         | ClawdbrainProtocol         | **OpenClawProtocol**         |
| ClawdbotDiscovery        | ClawdbrainDiscovery        | **OpenClawDiscovery**        |
| ClawdbotIPC              | ClawdbrainIPC              | **OpenClawIPC**              |
| ClawdbotMacCLI           | ClawdbrainMacCLI           | **OpenClawMacCLI**           |
| ClawdbotChatUI           | ClawdbrainChatUI           | **OpenClawChatUI**           |

### URLs and Domains

| Old               | Intermediate        | New                  |
| ----------------- | ------------------- | -------------------- |
| clawdbot.com      | clawdbrain.bot      | **openclaw.ai**      |
| docs.clawdbot.com | docs.clawdbrain.bot | **docs.openclaw.ai** |

### Environment Variables

| Old                  | Intermediate           | New                      |
| -------------------- | ---------------------- | ------------------------ |
| CLAWDBOT\_\*         | CLAWDBRAIN\_\*         | **OPENCLAW\_\***         |
| CLAWDBOT_CONFIG_PATH | CLAWDBRAIN_CONFIG_PATH | **OPENCLAW_CONFIG_PATH** |
| CLAWDBOT_STATE_DIR   | CLAWDBRAIN_STATE_DIR   | **OPENCLAW_STATE_DIR**   |

### File Paths

| Old                  | Intermediate           | New                      |
| -------------------- | ---------------------- | ------------------------ |
| ~/.clawdbot          | ~/.clawdbrain          | **~/.openclaw**          |
| clawdbot.json        | clawdbrain.json        | **openclaw.json**        |
| clawdbot.plugin.json | clawdbrain.plugin.json | **openclaw.plugin.json** |
| /tmp/clawdbot-\*     | /tmp/clawdbrain-\*     | **/tmp/openclaw-\***     |

### NPM Package Names

| Old          | Intermediate   | New              |
| ------------ | -------------- | ---------------- |
| clawdbot     | clawdbrain     | **openclaw**     |
| @clawdbot/\* | @clawdbrain/\* | **@openclaw/\*** |

### Swift Bundle Identifiers

| Old              | Intermediate       | New                 |
| ---------------- | ------------------ | ------------------- |
| com.clawdbot.mac | com.clawdbrain.mac | **ai.openclaw.mac** |
| com.clawdbot.ios | com.clawdbrain.ios | **ai.openclaw.ios** |

### CSS Variables

| Old                      | Intermediate               | New                          |
| ------------------------ | -------------------------- | ---------------------------- |
| --clawdbot-\*            | --clawdbrain-\*            | **--openclaw-\***            |
| --clawdbot-a2ui-inset-\* | --clawdbrain-a2ui-inset-\* | **--openclaw-a2ui-inset-\*** |

### Function Names

| Old                       | Intermediate                | New                           |
| ------------------------- | --------------------------- | ----------------------------- |
| createClawdbotCodingTools | createClawdbrainCodingTools | **createOpenClawCodingTools** |
| applyClawdbotConfig       | applyClawdbrainConfig       | **applyOpenClawConfig**       |

### GitHub Repositories

| Old                          | Intermediate                     | New                              |
| ---------------------------- | -------------------------------- | -------------------------------- |
| github.com/clawdbot/clawdbot | github.com/clawdbrain/clawdbrain | **github.com/openclaw/openclaw** |

## Naming Convention (Target State)

- Product name: **OpenClaw** / **openclaw**
- Package name: `openclaw`
- URLs: `openclaw.ai`, `docs.openclaw.ai`
- Environment variables: `OPENCLAW_*`
- Android package: `ai.openclaw.android`
- iOS/macOS modules: `OpenClaw`, `OpenClawKit`, `OpenClawProtocol`, etc.
- Config paths: `~/.openclaw/`
- Swift files: `OpenClaw` prefix for types/classes

## Conflict Resolution Strategy

### 1. File Status Categories

#### DD (Deleted by Both) - 480 files

**Resolution:** Accept deletion

```bash
git status --porcelain | grep '^DD ' | gsed 's/^DD //' | xargs -I {} git rm --quiet "{}"
```

#### UA (Added by Them, Modified by Us) - 482 files

**Context:** Files at `ai.openclaw.android` paths (correct final location)
**Resolution:** Accept theirs

```bash
git status --porcelain | grep '^UA ' | gsed 's/^UA //' | xargs -I {} sh -c 'git checkout --theirs "{}" && git add "{}"'
```

#### AU (Added by Us, Modified by Them) - 480 files

**Context:** Our intermediate `com.clawdbrain.android` files
**Resolution:** Delete (superseded by `ai.openclaw.android`)

```bash
git status --porcelain | grep '^AU ' | gsed 's/^AU //' | xargs -I {} git rm --quiet -f "{}"
```

#### UD (Modified by Us, Deleted by Them) - 9 files

**Context:** Files we modified but they renamed/moved to new OpenClaw locations
**Resolution:** Accept deletions (renamed versions exist at new paths)

```bash
git status --porcelain | grep '^UD ' | gsed 's/^UD //' | xargs -I {} git rm --quiet "{}"
```

Examples:

- `ClawdbrainPaths.swift` → `OpenClawPaths.swift`
- `telegram/pairing-store.ts` → `pairing/pairing-store.ts` (moved to shared location)

#### DU (Deleted by Us, Modified by Them) - 1 file

**Resolution:** Accept theirs

```bash
git checkout --theirs <file> && git add <file>
```

#### UU (Modified by Both) - 1,867 files

**Resolution:** Accept theirs (fork/main has OpenClaw naming), then fix any inconsistencies

### 2. Batch Resolution by File Type

```bash
# Swift/Kotlin files (pure naming changes)
git diff --name-only --diff-filter=U | grep -E '\.(swift|kt|kts)$' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# Markdown files (except CHANGELOG)
git diff --name-only --diff-filter=U | grep -E '\.(md|mdx)$' | grep -v CHANGELOG | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# YAML files
git diff --name-only --diff-filter=U | grep -E '\.(yml|yaml)$' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# TypeScript/JavaScript files
git diff --name-only --diff-filter=U | grep -E '\.(ts|tsx|js|jsx)$' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# Config files
git diff --name-only --diff-filter=U | grep -E '\.(css|html|json)$' | grep -v CHANGELOG | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done
```

### 3. Manual Resolution Examples

#### .gitignore

Fork/main had outdated `MoltbotKit`, should be `OpenClawKit`:

```
# Change:
apps/shared/MoltbotKit/.build/
apps/shared/MoltbotKit/.swiftpm/

# To:
apps/shared/OpenClawKit/.build/
apps/shared/OpenClawKit/.swiftpm/
```

#### CHANGELOG.md

Fork/main has more complete version history → Accept theirs

### 4. Post-Merge Fixes for Staged Files with Conflict Markers

Some files were staged but still contained conflict markers (8-char markers):

```bash
# Fix Swift files
grep -rl "<<<<<<" apps/macos/Sources/ --include="*.swift" | \
  while read file; do git show "fork/main:$file" > "$file" && git add "$file"; done

grep -rl "<<<<<<" apps/shared/OpenClawKit --include="*.swift" | \
  while read file; do git show "fork/main:$file" > "$file" && git add "$file"; done

# Fix TypeScript files
grep -rl "<<<<<<" src/ --include="*.ts" | \
  while read file; do git show "fork/main:$file" > "$file" && git add "$file"; done

# Fix Android files
grep -rl "<<<<<<" apps/android --include="*.kt" --include="*.xml" | \
  while read file; do git show "fork/main:$file" > "$file" && git add "$file"; done
```

### 5. Type Definition Fixes

After accepting fork/main's code, add missing type properties that our code uses:

#### SessionEntry (src/config/sessions/types.ts)

```typescript
export type SessionEntry = {
  // ... existing properties ...
  turnCount?: number;
  activeGoal?: any; // GoalState type
  description?: string;
  descriptionUpdatedAt?: number;
  descriptionTurnCount?: number;
  tags?: string[];
};
```

#### SessionListRow (src/agents/tools/sessions-helpers.ts)

```typescript
export type SessionListRow = {
  // ... existing properties ...
  reasoningLevel?: string;
  elevatedLevel?: string;
  description?: string;
  tags?: string[];
};
```

#### OpenClawConfig (src/config/types.openclaw.ts)

```typescript
export type OpenClawConfig = {
  // ... existing properties ...
  overseer?: any; // TODO: Add proper OverseerConfig type
  onboarding?: any; // TODO: Add proper OnboardingConfig type
};
```

#### GatewayRequestContext (src/gateway/server-methods/types.ts)

```typescript
export type GatewayRequestContext = {
  // ... existing properties ...
  automations?: any;
  overseerRunner?: any;
  artifactStorage?: any;
};
```

#### ResolvedAgentConfig (src/agents/agent-scope.ts)

```typescript
type ResolvedAgentConfig = {
  // ... existing properties ...
  runtime?: any;
  ccsdkProvider?: any;
};
```

#### PluginRegistry (src/plugins/registry.ts)

```typescript
export type PluginRegistry = {
  // ... existing properties ...
  cronJobs?: any;
};
```

#### server-close.ts - Make overseerRunner optional

```typescript
export function createGatewayCloseHandler(params: {
  // ... other params ...
  overseerRunner?: OverseerRunner | null; // Make optional
  // ... other params ...
}) {
  // ... in the handler:
  if (params.overseerRunner) {
    params.overseerRunner.stop();
  }
}
```

### 6. String Replacements (TypeScript Code)

```bash
# Replace config type names
grep -rl "ClawdbrainConfig" src/ --include="*.ts" | \
  while read file; do gsed -i 's/ClawdbrainConfig/OpenClawConfig/g' "$file"; done

grep -rl "ClawdbotConfig" src/ --include="*.ts" | \
  while read file; do gsed -i 's/ClawdbotConfig/OpenClawConfig/g' "$file"; done

# Replace function names
grep -rl "createClawdbrainCodingTools" src/ --include="*.ts" | \
  while read file; do gsed -i 's/createClawdbrainCodingTools/createOpenClawCodingTools/g' "$file"; done
```

### 7. Package.json - Restore Missing Dependencies

Check for packages in HEAD that aren't in merged version:

```bash
# Compare dependencies
diff <(git show HEAD:package.json | jq -r '.dependencies | keys[]' | sort) \
     <(jq -r '.dependencies | keys[]' package.json | sort) | \
     grep "^<" | gsed 's/^< //'

# Compare devDependencies
diff <(git show HEAD:package.json | jq -r '.devDependencies | keys[]' | sort) \
     <(jq -r '.devDependencies | keys[]' package.json | sort) | \
     grep "^<" | gsed 's/^< //'
```

Missing packages to add back:

- `@anthropic-ai/claude-agent-sdk`: "^0.2.20"
- `@modelcontextprotocol/sdk`: "^1.24.0"
- `@octokit/rest`: "^21.1.1"
- `body-parser`: "^2.2.2"
- `chromium-bidi`: "13.0.1"
- `detect-libc`: "^2.1.2"
- `simple-git`: "^3.30.0"
- `@mariozechner/mini-lit`: "0.2.1" (devDep)
- `@types/body-parser`: "^1.19.6" (devDep)
- `docx-preview`: "^0.3.7" (devDep)
- `lucide`: "^0.563.0" (devDep)
- `quicktype-core`: "^23.2.6" (devDep)
- `wireit`: "^0.14.12" (devDep)

After adding packages:

```bash
pnpm install
```

### 8. Import/Export Fixes

**applyZaiSdkConfig** → Remove from imports (function doesn't exist, use `applyZaiConfig` instead)

**GatewayModelEntry** → Replace with `ModelCatalogEntry`

### 9. Type Casting for Runtime Compatibility

When types don't fully match but runtime behavior is compatible:

```typescript
// Example: session descriptions
const preview = (session as any).description ?? session.lastMessagePreview;
```

### 10. Verification Steps

After all resolutions:

```bash
# Check no conflicts remain
git diff --name-only --diff-filter=U

# Check no conflict markers in source files
grep -rl "<<<<<<" . --include="*.ts" --include="*.swift" --include="*.kt" \
  --include="*.md" --include="*.json" 2>/dev/null | \
  grep -v node_modules | grep -v ".git" | grep -v "docs/designs"

# Build
pnpm build

# Lint (optional - style issues can be fixed separately)
pnpm lint
```

## Common Pitfalls

1. **Conflict markers in staged files**: Some files may be staged with 8-char conflict markers (`<<<<<<<<`) - need to manually fix these
2. **Example conflict markers in docs**: Files like `docs/designs/automations/02-automation-type-layer.md` have conflict markers as **content** (teaching examples) - these are valid and should not be removed
3. **Mixed naming in fork/main**: Some fork/main files still had old naming (Clawdbot, Moltbot) - always use OpenClaw as the final target
4. **Missing type properties**: Fork/main may not have all features from HEAD - add stub properties with `any` type to allow compilation

## Future Merge Conflict Prediction

### High-Confidence Future Conflicts

When merging future upstream changes, these areas will likely conflict again:

1. **New Features in Our Branch** (Not in Upstream)

   **Session System Enhancements:**
   - Files: `src/config/sessions/types.ts`, `src/agents/tools/sessions-*.ts`
   - Properties: `turnCount`, `activeGoal`, `description`, `descriptionUpdatedAt`, `descriptionTurnCount`, `tags`
   - Impact: Any upstream changes to SessionEntry will conflict
   - Resolution: Add our properties back after accepting upstream base

   **Overseer System:**
   - Files: `src/infra/overseer/*`, `src/gateway/server-methods/overseer.ts`, `src/slack/overseer/*`
   - Config: `config.overseer` property
   - Context: `overseerRunner` in GatewayRequestContext
   - Impact: Entire directory tree doesn't exist in upstream
   - Resolution: Keep our files, add `overseer?: any` to OpenClawConfig type

   **Automation System:**
   - Files: `src/automations/*`, `src/gateway/server-methods/automations.ts`
   - Config: `automations`, `artifactStorage` in GatewayRequestContext
   - Dependencies: Requires `@octokit/rest`, `simple-git`
   - Impact: Entire directory tree doesn't exist in upstream
   - Resolution: Keep our files, add properties to GatewayRequestContext type

   **Onboarding Metadata:**
   - Files: `src/wizard/onboarding-metadata.ts`
   - Config: `wizard.onboarding` property
   - Impact: Property doesn't exist in upstream wizard type
   - Resolution: Add `onboarding?: any` to wizard config type

   **Additional Features to Track:**
   - Claude Agent SDK integration (`src/agents/claude-agent-sdk/*`)
   - MCP SDK integration (`@modelcontextprotocol/sdk`)
   - Advanced session descriptions and tagging
   - Cron job plugins (`cronJobs` in PluginRegistry)

2. **Documentation URLs**
   - Any new docs with `docs.openclaw.ai` links will conflict if we use different URLs
   - CHANGELOG entries will always conflict on version bumps

3. **Package Names in Scripts**
   - Test scripts using `OPENCLAW_*` env vars
   - Install scripts referencing `openclaw.ai` URLs

### Low-Risk Areas (Unlikely to Conflict Again)

- Core TypeScript business logic (no naming in most code)
- Test files that don't reference product names
- Utility functions without branding

### Proactive Conflict Prevention

To minimize future conflicts when syncing with upstream:

1. **Keep local naming aligned**: Always use `openclaw` naming in new code
2. **Separate branding from logic**: Extract product names into constants/config
3. **Monitor upstream changes**: Check if upstream is adding features we already have
4. **Feature flags**: Consider feature flags for experimental features not in upstream

### Detecting Naming Inconsistencies

After merge, scan for remaining old naming patterns:

```bash
# Find files still using old naming (should return empty)
grep -r "clawdbot\|clawdbrain\|moltbot" . \
  --include="*.ts" --include="*.swift" --include="*.kt" \
  --include="*.md" --include="*.json" --include="*.xml" \
  --exclude-dir=node_modules --exclude-dir=.git \
  --exclude="*.lock*" --exclude="CHANGELOG.md" | \
  grep -v "docs/designs" | \
  grep -v "renamed ->" # Ignore migration messages

# Check for mixed case issues
grep -r "openclaw\|Openclaw\|OpenClaw" . --include="*.ts" | \
  grep -E "(class|interface|type|enum|const|let|var|function)" | \
  grep -v "OpenClaw[A-Z]" | # Should be PascalCase for types
  head -20

# Verify package name consistency
jq -r '.name' package.json # Should be: openclaw
jq -r '.name' packages/*/package.json # Check all workspace packages

# Verify Android namespace
grep "namespace\|applicationId\|package " apps/android/app/build.gradle.kts | \
  grep -v "ai.openclaw.android" # Should return empty

# Verify iOS/macOS bundle IDs
grep -r "CFBundleIdentifier\|PRODUCT_BUNDLE_IDENTIFIER" apps/ios apps/macos | \
  grep -v "ai.openclaw" # Should return empty or legacy migration refs only
```

### Naming Search Patterns for Review

When reviewing merged code, search for these patterns that indicate incomplete renaming:

```bash
# Case-sensitive product name checks
rg -i "clawdbot(?!.*renamed)" --type ts --type swift --type kotlin
rg -i "clawdbrain(?!.*renamed)" --type ts --type swift --type kotlin
rg -i "moltbot(?!.*renamed)" --type ts --type swift --type kotlin

# URL patterns
rg "clawdbot\.com|clawdbrain\.bot|docs\.clawd" --type md --type ts

# Environment variable patterns
rg "CLAWDBOT_|CLAWDBRAIN_" --type ts --type yaml --type sh

# Package/namespace patterns
rg "com\.clawdbot|com\.clawdbrain|com\.moltbot" --type kotlin --type xml
rg "@clawdbot/|@clawdbrain/|@moltbot/" --type ts --type json

# Config file patterns
rg "clawdbot\.json|clawdbrain\.json|moltbot\.json" --type ts

# Function/tool names
rg "createClawdbot|createClawdbrain|createMoltbot" --type ts

# CSS/HTML custom elements
rg "clawdbot-|clawdbrain-|moltbot-" --type css --type html --type js

# Swift/Kotlin imports
rg "import.*Clawdbot|import.*Clawdbrain|import.*Moltbot" --type swift --type kotlin
```

### Automated Conflict Resolution Script

Create a script for future merges:

```bash
#!/bin/bash
# resolve-upstream-merge.sh

# 1. Handle deletion conflicts
git status --porcelain | grep '^DD ' | gsed 's/^DD //' | xargs -I {} git rm --quiet "{}"
git status --porcelain | grep '^AU ' | gsed 's/^AU //' | xargs -I {} git rm --quiet -f "{}"
git status --porcelain | grep '^UD ' | gsed 's/^UD //' | xargs -I {} git rm --quiet "{}"

# 2. Accept upstream additions
git status --porcelain | grep '^UA ' | gsed 's/^UA //' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# 3. Accept upstream for DU files
git status --porcelain | grep '^DU ' | gsed 's/^DU //' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# 4. Batch resolve by file type
for pattern in '\.(swift|kt|kts)$' '\.(md|mdx)$' '\.(yml|yaml)$' '\.(sh)$' 'Dockerfile'; do
  git diff --name-only --diff-filter=U | grep -E "$pattern" | grep -v CHANGELOG | \
    while read file; do git checkout --theirs "$file" 2>/dev/null && git add "$file" 2>/dev/null; done
done

# 5. TypeScript/JavaScript files
git diff --name-only --diff-filter=U | grep -E '\.(ts|tsx|js|jsx)$' | \
  while read file; do git checkout --theirs "$file" 2>/dev/null && git add "$file" 2>/dev/null; done

# 6. Fix any remaining conflict markers in staged files
for dir in apps/macos/Sources apps/macos/Tests apps/shared apps/android src; do
  grep -rl "<<<<<<" "$dir" --include="*.swift" --include="*.kt" --include="*.ts" 2>/dev/null | \
    while read file; do
      git show "fork/main:$file" > "$file" 2>/dev/null && git add "$file"
    done
done

# 7. Apply naming fixes
grep -rl "ClawdbrainConfig\|ClawdbotConfig" src/ --include="*.ts" | \
  while read file; do
    gsed -i 's/ClawdbrainConfig/OpenClawConfig/g;s/ClawdbotConfig/OpenClawConfig/g' "$file"
  done

grep -rl "createClawdbrainCodingTools" src/ --include="*.ts" | \
  while read file; do
    gsed -i 's/createClawdbrainCodingTools/createOpenClawCodingTools/g' "$file"
  done

# 8. Manual review checklist
echo "Manual steps required:"
echo "1. Review .gitignore for Kit naming (should be OpenClawKit)"
echo "2. Review CHANGELOG.md for content merge"
echo "3. Add missing type properties (see Type Definition Fixes section)"
echo "4. Restore missing packages from HEAD to package.json"
echo "5. Run: pnpm install && pnpm build"
```

## Systematic Re-Sync Process

For future upstream merges, follow this sequence:

### Phase 1: Pre-Merge Preparation

```bash
# 1. Create merge branch
git checkout -b upstream-merge-$(date +%Y%m%d)

# 2. Fetch upstream
git fetch fork main

# 3. Attempt merge
git merge fork/main
# Expected: 3000+ conflicts

# 4. Document current state
git status --porcelain > /tmp/merge-conflicts-initial.txt
```

### Phase 2: Bulk Conflict Resolution (90%+ of files)

```bash
# Execute in order - each step is safe and automated:

# Step 1: Handle deletions (DD, AU, UD)
git status --porcelain | grep '^DD ' | gsed 's/^DD //' | xargs -I {} git rm --quiet "{}"
git status --porcelain | grep '^AU ' | gsed 's/^AU //' | xargs -I {} git rm --quiet -f "{}"
git status --porcelain | grep '^UD ' | gsed 's/^UD //' | xargs -I {} git rm --quiet "{}"

# Step 2: Accept upstream additions (UA, DU)
git status --porcelain | grep '^UA ' | gsed 's/^UA //' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done
git status --porcelain | grep '^DU ' | gsed 's/^DU //' | \
  while read file; do git checkout --theirs "$file" && git add "$file"; done

# Step 3: Batch resolve UU by file type
for ext in "swift|kt|kts" "md|mdx" "yml|yaml" "sh" "css|html"; do
  git diff --name-only --diff-filter=U | grep -E "\.($ext)$" | grep -v CHANGELOG | \
    while read file; do git checkout --theirs "$file" 2>/dev/null && git add "$file" 2>/dev/null; done
done

# Step 4: TypeScript/JavaScript files
git diff --name-only --diff-filter=U | grep -E '\.(ts|tsx|js|jsx)$' | \
  while read file; do git checkout --theirs "$file" 2>/dev/null && git add "$file" 2>/dev/null; done

# Step 5: Verify no unresolved conflicts
git diff --name-only --diff-filter=U
# Should be empty or just a few manual files like .gitignore, CHANGELOG.md
```

### Phase 3: Manual Conflict Resolution

```bash
# Remaining files (typically < 10):
# - .gitignore: Use OpenClawKit, not MoltbotKit or ClawdbrainKit
# - CHANGELOG.md: Accept theirs (has more complete history)
# - Any config files with substantive differences

# Fix .gitignore
gsed -i 's|ClawdbrainKit|OpenClawKit|g;s|MoltbotKit|OpenClawKit|g' .gitignore
git add .gitignore

# Accept CHANGELOG
git checkout --theirs CHANGELOG.md && git add CHANGELOG.md
```

### Phase 4: Fix Staged Files with Conflict Markers

```bash
# Some files may be staged but still have conflict markers
# Fix them by taking fork/main's version:

for dir in apps/macos/Sources apps/macos/Tests apps/shared/OpenClawKit apps/android src; do
  [ -d "$dir" ] && grep -rl "<<<<<<" "$dir" \
    --include="*.swift" --include="*.kt" --include="*.ts" \
    --include="*.js" --include="*.mjs" 2>/dev/null | \
    while read file; do
      git show "fork/main:$file" > "$file" 2>/dev/null && git add "$file"
    done
done
```

### Phase 5: Type System Repairs

```bash
# Apply type fixes (copy-paste these edits):

# 1. src/config/sessions/types.ts - Add to SessionEntry:
#    turnCount?: number;
#    activeGoal?: any;
#    description?: string;
#    descriptionUpdatedAt?: number;
#    descriptionTurnCount?: number;
#    tags?: string[];

# 2. src/agents/tools/sessions-helpers.ts - Add to SessionListRow:
#    reasoningLevel?: string;
#    elevatedLevel?: string;
#    description?: string;
#    tags?: string[];

# 3. src/config/types.openclaw.ts - Add to OpenClawConfig:
#    overseer?: any;
#    onboarding?: any;

# 4. src/config/types.openclaw.ts - Add to wizard:
#    wizard?: {
#      // ... existing ...
#      onboarding?: any;
#    };

# 5. src/gateway/server-methods/types.ts - Add to GatewayRequestContext:
#    automations?: any;
#    overseerRunner?: any;
#    artifactStorage?: any;

# 6. src/agents/agent-scope.ts - Add to ResolvedAgentConfig:
#    runtime?: any;
#    ccsdkProvider?: any;

# 7. src/plugins/registry.ts - Add to PluginRegistry:
#    cronJobs?: any;

# 8. src/gateway/server-close.ts - Make overseerRunner optional:
#    overseerRunner?: OverseerRunner | null;
#    // And add null check in handler:
#    if (params.overseerRunner) { params.overseerRunner.stop(); }

# 9. src/tui/tui-command-handlers.ts - Add type casts for description:
#    const preview = ((session as any).description ?? session.lastMessagePreview)
#    // Also in searchText array
```

### Phase 6: String Replacements

```bash
# Fix type name references
grep -rl "ClawdbrainConfig\|ClawdbotConfig" src/ --include="*.ts" | \
  while read file; do
    gsed -i 's/ClawdbrainConfig/OpenClawConfig/g;s/ClawdbotConfig/OpenClawConfig/g' "$file"
  done

# Fix function references
grep -rl "createClawdbrainCodingTools" src/ --include="*.ts" | \
  while read file; do
    gsed -i 's/createClawdbrainCodingTools/createOpenClawCodingTools/g' "$file"
  done

# Fix import/export issues
# Remove applyZaiSdkConfig import (doesn't exist, use applyZaiConfig)
# Replace GatewayModelEntry with ModelCatalogEntry

git add -u
```

### Phase 7: Package Dependencies

```bash
# Compare and restore missing packages
git show HEAD:package.json | jq '.dependencies' > /tmp/head-deps.json
jq '.dependencies' package.json > /tmp/current-deps.json

# Manually add back to package.json:
# "@anthropic-ai/claude-agent-sdk": "^0.2.20",
# "@modelcontextprotocol/sdk": "^1.24.0",
# "@octokit/rest": "^21.1.1",
# "body-parser": "^2.2.2",
# "chromium-bidi": "13.0.1",
# "detect-libc": "^2.1.2",
# "simple-git": "^3.30.0",

# devDependencies:
# "@mariozechner/mini-lit": "0.2.1",
# "@types/body-parser": "^1.19.6",
# "docx-preview": "^0.3.7",
# "lucide": "^0.563.0",
# "quicktype-core": "^23.2.6",
# "wireit": "^0.14.12",

# Install
pnpm install
```

### Phase 8: Build & Verify

```bash
# Build
pnpm build
# Should succeed with 0 TypeScript errors

# Lint (optional - can fix style issues later)
pnpm lint | grep "error TS" # Should be empty

# Test key functionality
pnpm test 2>&1 | grep -E "PASS|FAIL|Error" | head -20
```

### Phase 9: Post-Merge Cleanup

```bash
# Stage all fixes
git add -u

# Commit the merge
git commit -m "Merge upstream OpenClaw changes

- Resolved 3,319 file conflicts
- Applied OpenClaw naming across codebase
- Restored feature-specific type definitions
- Added missing dependencies for extended features

Co-Authored-By: Claude Sonnet 4.5 (1M context) <noreply@anthropic.com>"

# Verify clean state
git status
```

### Automated Conflict Resolution Script

Create a script for future merges:

## Critical Files Requiring Manual Attention

### Always Review These Files

1. **CHANGELOG.md** - Has different content entries, not just naming
2. **.gitignore** - Kit naming (OpenClawKit vs MoltbotKit/ClawdbrainKit)
3. **CLAUDE.md** - Repository guidelines, URLs, commands
4. **package.json** - Dependencies may diverge
5. **apps/android/app/build.gradle.kts** - namespace, applicationId, outputFileName
6. **apps/\*/Info.plist** - Bundle IDs and version strings

### Files That Are Safe to Auto-Accept (Theirs)

- All `*.swift` files in `apps/macos/Sources/OpenClaw*`
- All `*.kt` files in `apps/android/.../ai/openclaw/android`
- All `*.md` files in `docs/` (except note personal edits)
- All workflow files in `.github/workflows/`
- All skill definitions `skills/*/SKILL.md`
- All extension configs `extensions/*/package.json`

### Files That Need Logic Preservation

These files may have logic changes beyond naming:

- `src/gateway/server.impl.ts` - May have new RPC methods
- `src/config/types.*.ts` - Type definitions
- `src/agents/agent-scope.ts` - Agent resolution logic
- `src/sessions/session-description.ts` - Session handling logic

### Directory-Level Patterns

**Entire Directories to Accept from Upstream:**

- `apps/macos/Sources/OpenClaw*/` - Complete OpenClaw Swift sources
- `apps/shared/OpenClawKit/` - Shared Swift kit
- `apps/android/.../ai/openclaw/android/` - Android OpenClaw package

**Entire Directories Unique to Our Branch:**

- `src/automations/` - Not in upstream, keep ours
- `src/infra/overseer/` - Not in upstream, keep ours
- `src/agents/claude-agent-sdk/` - Not in upstream, keep ours
- `.pi/` - Not in upstream, keep ours

**Directories to Delete (Old Naming):**

- `apps/macos/Sources/Clawdbrain/` - After confirming migration to OpenClaw
- `apps/shared/ClawdbrainKit/` - After confirming migration to OpenClawKit
- `apps/android/.../com/clawdbrain/android/` - After confirming migration to ai.openclaw.android

## Summary Stats

- Total conflicts: 3,319 files
- Auto-resolved: ~3,300 files
- Manual fixes: ~20 files (gitignore, build configs, type definitions)
- Type additions: 8 type definitions enhanced
- Package additions: 13 packages restored
- Build time after resolution: ~20 seconds
- Final state: Build passing, 1320 lint style issues (non-critical)
