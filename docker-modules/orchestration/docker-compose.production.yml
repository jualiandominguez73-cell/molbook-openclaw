# OpenClaw Production Docker Compose
# Complete stack with security, monitoring, and persistence

version: "3.8"

services:
  #============================================================================
  # Core Services
  #============================================================================

  openclaw-gateway:
    build:
      context: ../..
      dockerfile: docker-modules/base/Dockerfile.production
    image: ${OPENCLAW_IMAGE:-openclaw:production}
    container_name: openclaw-gateway
    hostname: openclaw-gateway
    restart: unless-stopped
    init: true
    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]

    environment:
      NODE_ENV: production
      HOME: /home/openclaw
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_ENCRYPTION_KEY: ${OPENCLAW_ENCRYPTION_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      ANTHROPIC_OAUTH_TOKEN: ${ANTHROPIC_OAUTH_TOKEN:-}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
      DATABASE_URL: postgresql://openclaw:${POSTGRES_PASSWORD}@postgres:5432/openclaw
      REDIS_URL: redis://redis:6379

    volumes:
      - openclaw-config:/home/openclaw/.openclaw
      - openclaw-workspace:/home/openclaw/.openclaw/workspace
      - openclaw-logs:/home/openclaw/.openclaw/logs
      - openclaw-data:/home/openclaw/.openclaw/data

    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"

    networks:
      - openclaw-internal

    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: false

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  #============================================================================
  # CLI Service
  #============================================================================

  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:production}
    container_name: openclaw-cli
    environment:
      HOME: /home/openclaw
      TERM: xterm-256color
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      DATABASE_URL: postgresql://openclaw:${POSTGRES_PASSWORD}@postgres:5432/openclaw
      REDIS_URL: redis://redis:6379

    volumes:
      - openclaw-config:/home/openclaw/.openclaw
      - openclaw-workspace:/home/openclaw/.openclaw/workspace

    networks:
      - openclaw-internal

    stdin_open: true
    tty: true
    init: true

    entrypoint: ["node", "dist/index.js"]

    profiles:
      - cli

  #============================================================================
  # Sandbox Services
  #============================================================================

  openclaw-sandbox:
    build:
      context: .
      dockerfile: ../sandbox/Dockerfile.sandbox
    image: ${OPENCLAW_SANDBOX_IMAGE:-openclaw-sandbox:production}
    container_name: openclaw-sandbox
    restart: unless-stopped

    volumes:
      - sandbox-workspace:/workspace

    networks:
      - openclaw-sandbox

    # Security hardening
    security_opt:
      - no-new-privileges:true
      - seccomp:../security/seccomp-sandbox.json
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=100m
      - /sandbox-tmp:rw,noexec,nosuid,size=100m

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 512M
          pids: 100
        reservations:
          cpus: "0.25"
          memory: 64M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  openclaw-browser:
    build:
      context: ../sandbox
      dockerfile: Dockerfile.browser
    image: ${OPENCLAW_BROWSER_IMAGE:-openclaw-browser:production}
    container_name: openclaw-browser
    restart: unless-stopped

    environment:
      DISPLAY: ":99"

    volumes:
      - browser-workspace:/workspace

    ports:
      - "${OPENCLAW_VNC_PORT:-5900}:5900"
      - "${OPENCLAW_NOVNC_PORT:-6080}:6080"

    networks:
      - openclaw-internal
      - openclaw-sandbox

    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SYS_ADMIN  # Required for Chromium sandbox

    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9222/json/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    profiles:
      - browser

  #============================================================================
  # Database Services
  #============================================================================

  postgres:
    image: postgres:16-alpine
    container_name: openclaw-postgres
    restart: unless-stopped

    environment:
      POSTGRES_USER: openclaw
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: openclaw
      PGDATA: /var/lib/postgresql/data/pgdata

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro

    networks:
      - openclaw-internal

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openclaw -d openclaw"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: openclaw-redis
    restart: unless-stopped

    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

    volumes:
      - redis-data:/data

    networks:
      - openclaw-internal

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  #============================================================================
  # Monitoring Services (Optional)
  #============================================================================

  prometheus:
    image: prom/prometheus:latest
    container_name: openclaw-prometheus
    restart: unless-stopped

    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"

    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ../monitoring/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus

    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"

    networks:
      - openclaw-internal

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

    profiles:
      - monitoring

  loki:
    image: grafana/loki:latest
    container_name: openclaw-loki
    restart: unless-stopped

    command: -config.file=/etc/loki/loki-config.yml

    volumes:
      - ../monitoring/loki-config.yml:/etc/loki/loki-config.yml:ro
      - loki-data:/loki

    ports:
      - "${LOKI_PORT:-3100}:3100"

    networks:
      - openclaw-internal

    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

    profiles:
      - monitoring

#============================================================================
# Networks
#============================================================================

networks:
  openclaw-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  openclaw-sandbox:
    driver: bridge
    internal: true  # No external network access
    ipam:
      config:
        - subnet: 172.21.0.0/16

#============================================================================
# Volumes
#============================================================================

volumes:
  openclaw-config:
    name: openclaw-config
  openclaw-workspace:
    name: openclaw-workspace
  openclaw-logs:
    name: openclaw-logs
  openclaw-data:
    name: openclaw-data
  sandbox-workspace:
    name: openclaw-sandbox-workspace
  browser-workspace:
    name: openclaw-browser-workspace
  postgres-data:
    name: openclaw-postgres-data
  redis-data:
    name: openclaw-redis-data
  prometheus-data:
    name: openclaw-prometheus-data
  loki-data:
    name: openclaw-loki-data
