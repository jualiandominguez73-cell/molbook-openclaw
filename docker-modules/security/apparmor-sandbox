#include <tunables/global>

# OpenClaw Sandbox AppArmor Profile
# Restricts sandbox containers to minimal required access

profile openclaw-sandbox flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Deny all file access by default
  deny /** w,

  # Allow read access to essential system files
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/hosts r,
  /etc/resolv.conf r,
  /etc/ssl/** r,
  /etc/ca-certificates/** r,
  /usr/share/ca-certificates/** r,

  # Allow read access to system libraries
  /lib/** r,
  /lib64/** r,
  /usr/lib/** r,
  /usr/lib64/** r,

  # Allow read/execute for binaries
  /bin/** rix,
  /usr/bin/** rix,
  /usr/local/bin/** rix,

  # Allow access to workspace directory (read/write)
  /workspace/** rw,
  /workspace/ rw,

  # Allow access to sandbox tmp directory
  /sandbox-tmp/** rw,
  /sandbox-tmp/ rw,

  # Allow access to user home (limited)
  /home/sandbox/** rw,
  /home/sandbox/ rw,

  # Allow proc filesystem access (limited)
  /proc/*/stat r,
  /proc/*/status r,
  /proc/*/fd/ r,
  /proc/sys/kernel/random/uuid r,
  /proc/sys/kernel/osrelease r,

  # Allow /dev access (limited)
  /dev/null rw,
  /dev/zero r,
  /dev/urandom r,
  /dev/random r,
  /dev/tty rw,
  /dev/pts/* rw,

  # Allow tmp directory access
  /tmp/** rw,
  /var/tmp/** rw,

  # Deny dangerous operations
  deny /proc/*/mem rw,
  deny /proc/kcore rw,
  deny /proc/kmem rw,
  deny /sys/** w,
  deny /boot/** rwx,

  # Deny mount operations
  deny mount,
  deny umount,
  deny pivot_root,

  # Deny ptrace
  deny ptrace,

  # Network access - deny for code sandbox
  # (Enable for browser sandbox by removing these lines)
  deny network inet,
  deny network inet6,

  # Capabilities - deny all
  deny capability,
}

# Browser sandbox profile (allows network)
profile openclaw-browser-sandbox flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>

  # Same base restrictions as sandbox
  deny /** w,

  # Allow read access to essential system files
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/hosts r,
  /etc/resolv.conf r,
  /etc/ssl/** r,
  /etc/ca-certificates/** r,
  /usr/share/ca-certificates/** r,
  /etc/fonts/** r,

  # Allow read access to system libraries
  /lib/** r,
  /lib64/** r,
  /usr/lib/** r,
  /usr/lib64/** r,

  # Allow read/execute for binaries
  /bin/** rix,
  /usr/bin/** rix,
  /usr/local/bin/** rix,

  # Allow workspace access
  /workspace/** rw,
  /workspace/ rw,

  # Allow browser user home
  /home/browser/** rw,
  /home/browser/ rw,

  # Allow Chromium specific paths
  /usr/share/chromium/** r,
  /usr/share/fonts/** r,
  /usr/share/X11/** r,

  # Allow proc filesystem access (limited)
  /proc/*/stat r,
  /proc/*/status r,
  /proc/*/fd/ r,
  /proc/sys/kernel/random/uuid r,

  # Allow /dev access
  /dev/null rw,
  /dev/zero r,
  /dev/urandom r,
  /dev/random r,
  /dev/tty rw,
  /dev/pts/* rw,
  /dev/shm/** rw,
  /dev/dri/** rw,

  # Allow tmp directory access
  /tmp/** rw,
  /var/tmp/** rw,

  # Allow network for browser sandbox
  network inet stream,
  network inet dgram,
  network inet6 stream,
  network inet6 dgram,

  # Deny dangerous operations
  deny /proc/*/mem rw,
  deny /proc/kcore rw,
  deny /boot/** rwx,
  deny mount,
  deny umount,
  deny ptrace,

  # Limited capabilities for browser
  capability net_bind_service,
  deny capability sys_admin,
  deny capability sys_ptrace,
}
